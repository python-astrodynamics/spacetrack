stages:
  - test
  - report

variables:
  PIP_CACHE_DIR: .cache/pip
  PRE_COMMIT_HOME: .cache/pre-commit
  TOX_TESTENV_PASSENV: PIP_CACHE_DIR

.pipcache:
  cache:
    key: pip
    paths:
      - $PIP_CACHE_DIR

.pytest:
  extends: .pipcache
  stage: test
  before_script:
    - pip install -U pip setuptools wheel
    - pip install -U virtualenv tox
  script:
    - tox -- -v --junitxml=junit.xml
  artifacts:
    when: always
    paths:
      - .coverage.*
    reports:
      junit: junit.xml

test:3.7:
  extends: .pytest
  image: python:3.7
  variables:
    TOXENV: py37

test:3.8:
  extends: .pytest
  image: python:3.8
  variables:
    TOXENV: py38

test:3.9:
  extends: .pytest
  image: python:3.9
  variables:
    TOXENV: py39

test:3.10:
  extends: .pytest
  image: python:3.10
  variables:
    TOXENV: py310

pre-commit:
  stage: test
  image: python:3.10
  before_script:
    - pip install pre-commit
  script:
    - pre-commit run --all-files
  cache:
    key: pre-commit
    paths:
      - $PIP_CACHE_DIR
      - $PRE_COMMIT_HOME

coverage:
  extends: .pipcache
  stage: report
  image: python:3.10
  before_script:
    - pip install -U pip setuptools wheel
    - pip install -U coverage[toml]
  script:
    - coverage combine
    - coverage report
    - coverage html
    - coverage xml
  when: always
  artifacts:
    name: coverage-${CI_COMMIT_SHORT_SHA}
    expose_as: Coverage Report
    paths:
      - htmlcov
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
  needs:
    - test:3.7
    - test:3.8
    - test:3.9
    - test:3.10
